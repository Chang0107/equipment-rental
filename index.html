<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>器材租借系統</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 FontAwesome 圖示 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: 120px; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 0.3s ease-out; }
        .lightbox-active { opacity: 1 !important; pointer-events: auto !important; }

        /* 成功勾勾動畫：彈跳出現 */
        @keyframes checkmark-pop {
            0% { transform: scale(0); opacity: 0; }
            70% { transform: scale(1.25); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* 背景脈衝動畫 */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .animate-check-pop {
            animation: checkmark-pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .animate-pulse-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #d1fae5; /* green-100 */
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
            z-index: 0;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col">

    <!-- 導覽列 -->
    <nav class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between h-16 items-center">
            <div class="flex items-center">
                <i class="fas fa-camera-retro text-blue-600 text-2xl mr-2"></i>
                <span class="font-bold text-xl tracking-wider text-gray-900">器材租借</span>
            </div>
        </div>
    </nav>

    <!-- 主要內容區 -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full pb-safe">
        
        <!-- ========================================== -->
        <!-- Step 1: 器材選擇區 -->
        <!-- ========================================== -->
        <div id="step1">
            <div class="mb-8">
                <h1 class="text-3xl font-extrabold text-gray-900 mb-2">器材目錄</h1>
                <p class="text-gray-500">瀏覽並選擇您需要租借的設備。點擊圖片可放大查看。</p>
            </div>

            <div id="loading" class="flex flex-col items-center justify-center py-20">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                <p class="text-gray-500">讀取資料中...</p>
            </div>

            <div id="equipmentGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 hidden"></div>
        </div>

        <!-- ========================================== -->
        <!-- Step 2: 填寫資料頁面 -->
        <!-- ========================================== -->
        <div id="step2" class="hidden max-w-3xl mx-auto">
            <button onclick="goToStep1()" class="mb-6 text-gray-500 hover:text-blue-600 font-bold transition flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> 返回目錄修改
            </button>
            <h2 class="text-3xl font-extrabold text-gray-900 mb-6">填寫預約資料</h2>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
                <h3 class="font-bold text-gray-700 border-b pb-3 mb-4 flex items-center">已選清單</h3>
                <div id="cartItemsList" class="space-y-3"></div>
            </div>

            <form id="checkoutForm" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 space-y-6" onsubmit="submitOrder(event)">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">借出日期</label><input type="date" id="startDate" required class="w-full border border-gray-300 rounded-lg px-4 py-3 outline-none transition focus:ring-2 focus:ring-blue-500" onchange="calculateTotal()"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">歸還日期</label><input type="date" id="endDate" required class="w-full border border-gray-300 rounded-lg px-4 py-3 outline-none transition focus:ring-2 focus:ring-blue-500" onchange="calculateTotal()"></div>
                </div>
                <div class="bg-blue-50 rounded-xl p-6 border border-blue-100 flex flex-col sm:flex-row justify-between items-center">
                    <div class="text-sm text-blue-800">預估天數：<span id="rentalDays" class="font-bold text-lg">0</span> 天<br>每日小計：NT$ <span id="dailyTotal">0</span></div>
                    <div class="text-right"><span class="text-sm text-blue-600 block font-bold">預估總金額</span><span class="text-3xl font-extrabold text-blue-700">NT$ <span id="grandTotal">0</span></span></div>
                </div>
                <input type="text" id="userName" required placeholder="申請人姓名" class="w-full border border-gray-300 rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500">
                <input type="email" id="userEmail" required placeholder="聯絡信箱" class="w-full border border-gray-300 rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500">
                <textarea id="userPurpose" required rows="4" placeholder="租借用途與說明" class="w-full border border-gray-300 rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                <button type="submit" id="submitBtn" disabled class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-md text-lg disabled:opacity-50 transition hover:bg-blue-700">確認送出申請</button>
            </form>
        </div>

        <!-- ========================================== -->
        <!-- Step 3: 成功頁面  -->
        <!-- ========================================== -->
        <div id="step3" class="hidden max-w-2xl mx-auto text-center py-12">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-10">
                <!-- 放大並增加動畫的勾勾區域 -->
                <div class="relative w-32 h-32 mx-auto mb-8 flex items-center justify-center">
                    <div class="animate-pulse-ring"></div>
                    <div class="relative z-10 w-full h-full bg-green-100 text-green-600 rounded-full flex items-center justify-center animate-check-pop shadow-inner">
                        <i class="fas fa-check text-6xl"></i>
                    </div>
                </div>

                <h2 class="text-3xl font-black text-gray-900 mb-4">申請已送出成功！</h2>
                <p class="text-gray-500 mb-8 text-lg">我們已收到您的器材租借預約，系統已自動寄出確認信至您的電子信箱。管理員將會盡快審核並與您聯繫。</p>
                
                <div class="bg-gray-50 rounded-xl p-6 mb-8 text-left inline-block w-full">
                    <h4 class="font-bold text-gray-700 mb-2 underline">接下來您可以：</h4>
                    <ul class="text-gray-600 space-y-2 text-sm">
                        <li><i class="fas fa-envelope mr-2 text-blue-500"></i> 到您的信箱檢查是否有收到確認通知信。</li>
                        <li><i class="fas fa-phone-alt mr-2 text-blue-500"></i> 等待管理員與您確認器材檔期。</li>
                        <li><i class="fas fa-file-signature mr-2 text-blue-500"></i> 準備好您的身份證件以便取件時查驗。</li>
                    </ul>
                </div>

                <button onclick="window.location.reload()" class="bg-blue-600 text-white px-10 py-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition w-full sm:w-auto">
                    返回器材首頁
                </button>
            </div>
        </div>

    </main>

    <!-- 下方控制列 -->
    <div id="bottomBar" class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 z-40 transform translate-y-full transition-transform duration-300">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center"><div class="bg-blue-100 text-blue-600 w-10 h-10 rounded-full flex items-center justify-center font-bold mr-3" id="bottomBarCount">0</div><span class="font-bold text-gray-700">個品項已選</span></div>
            <button onclick="goToStep2()" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-md hover:bg-blue-700 transition">下一步填寫資料 <i class="fas fa-arrow-right ml-2"></i></button>
        </div>
    </div>

    <!-- 圖片燈箱 -->
    <div id="lightbox" class="fixed inset-0 z-[100] bg-black bg-opacity-90 hidden flex justify-center items-center cursor-zoom-out opacity-0 transition-opacity duration-300" onclick="closeLightbox()">
        <img id="lightboxImg" src="" class="max-w-[95vw] max-h-[95vh] object-contain rounded-lg shadow-2xl transform scale-95 transition-transform duration-300">
    </div>

    <div id="toastContainer" class="fixed top-5 right-5 z-[110] flex flex-col space-y-2 pointer-events-none"></div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzhfJfkqwfDae_He4tCnAFSebDC8SfUL2YBJptLbXVDzJOlTejPLdq8Lf5zKVSVMJJZ/exec"; 
        
        let equipmentData = [];
        let cart = [];

        window.onload = () => {
            fetchEquipment();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').min = today;
            document.getElementById('endDate').min = today;
        };

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            let bgColor = 'bg-gray-800';
            if (type === 'success') bgColor = 'bg-green-600';
            if (type === 'error') bgColor = 'bg-red-600';
            toast.className = `${bgColor} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center toast-enter-active pointer-events-auto`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        async function fetchEquipment() {
            try {
                if(SCRIPT_URL.includes("請替換成")) {
                    equipmentData = [{id: 'demo-1', name: '範例器材', category: '攝影', specs: 'RS 3', status: '可租借', price: 500, imageUrl: ''}];
                } else {
                    const response = await fetch(SCRIPT_URL);
                    equipmentData = await response.json();
                }
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('equipmentGrid').classList.remove('hidden');
                renderEquipment();
            } catch (error) { showToast("連線讀取失敗", "error"); }
        }

        function renderEquipment() {
            const grid = document.getElementById('equipmentGrid');
            grid.innerHTML = '';
            equipmentData.forEach(item => {
                const isSelected = cart.some(c => c.id === item.id);
                const isAvailable = item.status === '可租借';
                const hasImage = item.imageUrl && item.imageUrl.trim() !== '';
                
                const card = document.createElement('div');
                card.className = `bg-white rounded-xl overflow-hidden flex flex-col border transition-all ${isSelected ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-200 shadow-md' : 'border-gray-200 shadow-sm'}`;
                
                const imageContainer = `
                    <div class="h-48 bg-white relative overflow-hidden flex items-center justify-center p-2 border-b border-gray-50">
                        ${hasImage ? 
                            `<img src="${item.imageUrl}" 
                                  onclick="openLightbox('${item.imageUrl}')" 
                                  onerror="handleImgError(this)"
                                  class="max-w-full max-h-full object-contain cursor-zoom-in transition-transform duration-300 hover:scale-105">` : 
                            `<i class="fas fa-image text-gray-200 text-5xl"></i>`
                        }
                    </div>`;

                card.innerHTML = `
                    ${imageContainer}
                    <div class="p-5 flex flex-col flex-grow">
                        <h3 class="font-bold text-lg mb-1 leading-tight text-gray-800">${item.name}</h3>
                        <p class="text-sm text-gray-500 mb-4 flex-grow">${item.specs}</p>
                        <div class="border-t pt-4">
                            <div class="text-blue-600 font-bold mb-3 text-center">NT$ ${item.price} / 天</div>
                            <button onclick="${isSelected ? `removeFromCart` : `addToCart`}('${item.id}')" 
                                    class="w-full py-2 rounded-lg font-bold transition ${!isAvailable ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : (isSelected ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600')}" ${!isAvailable ? 'disabled' : ''}>
                                ${!isAvailable ? '已借出' : (isSelected ? '取消選擇' : '加入租借')}
                            </button>
                        </div>
                    </div>`;
                grid.appendChild(card);
            });
        }

        function handleImgError(img) {
            const p = img.parentElement; img.remove();
            p.innerHTML = `<div class="flex flex-col items-center"><i class="fas fa-exclamation-triangle text-yellow-400 mb-1"></i><span class="text-xs text-gray-400">圖片網址錯誤</span></div>`;
        }

        function openLightbox(src) {
            const lb = document.getElementById('lightbox'); const img = document.getElementById('lightboxImg');
            img.src = src; lb.classList.remove('hidden');
            setTimeout(() => { lb.classList.add('lightbox-active'); img.classList.add('scale-100'); }, 10);
        }

        function closeLightbox() {
            const lb = document.getElementById('lightbox');
            lb.classList.remove('lightbox-active');
            setTimeout(() => { lb.classList.add('hidden'); }, 300);
        }

        function addToCart(id) {
            const item = equipmentData.find(e => e.id === id);
            cart.push(item);
            renderEquipment();
            updateBottomBar();
        }

        function removeFromCart(id) {
            cart = cart.filter(item => item.id !== id);
            renderEquipment();
            updateBottomBar();
            if (!document.getElementById('step2').classList.contains('hidden')) renderStep2Cart();
        }

        function updateBottomBar() {
            const bar = document.getElementById('bottomBar');
            document.getElementById('bottomBarCount').textContent = cart.length;
            if (cart.length > 0 && !document.getElementById('step1').classList.contains('hidden')) {
                bar.classList.remove('translate-y-full');
            } else { bar.classList.add('translate-y-full'); }
        }

        function goToStep2() {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('bottomBar').classList.add('translate-y-full');
            document.getElementById('step2').classList.remove('hidden');
            document.getElementById('step3').classList.add('hidden');
            window.scrollTo(0,0);
            renderStep2Cart();
        }

        function goToStep1() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
            updateBottomBar();
            window.scrollTo(0,0);
        }

        function renderStep2Cart() {
            const list = document.getElementById('cartItemsList');
            list.innerHTML = '';
            if (cart.length === 0) { goToStep1(); return; }
            let daily = 0;
            cart.forEach(item => {
                daily += parseInt(item.price);
                const el = document.createElement('div');
                el.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg border';
                el.innerHTML = `<div><div class="font-bold text-gray-800">${item.name}</div><div class="text-sm text-blue-600 font-bold">NT$ ${item.price} / 天</div></div>
                                <button onclick="removeFromCart('${item.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded-full"><i class="fas fa-trash"></i></button>`;
                list.appendChild(el);
            });
            document.getElementById('dailyTotal').textContent = daily.toLocaleString();
            calculateTotal();
        }

        function calculateTotal() {
            const s = document.getElementById('startDate').value;
            const e = document.getElementById('endDate').value;
            let d = 0;
            if (s && e) {
                const diff = new Date(e) - new Date(s);
                d = Math.max(0, Math.ceil(diff / (1000*60*60*24)) + 1);
            }
            document.getElementById('rentalDays').textContent = d;
            let daily = 0; cart.forEach(i => daily += parseInt(i.price));
            document.getElementById('grandTotal').textContent = (daily * d).toLocaleString();
            document.getElementById('submitBtn').disabled = (d <= 0 || cart.length === 0);
        }

        async function submitOrder(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> 正在傳送申請...';
            
            const payload = {
                action: 'checkout',
                cart: cart,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                purpose: document.getElementById('userPurpose').value
            };

            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                if (json.result === 'success') {
                    // 切換至【獨立成功頁面】
                    document.getElementById('step2').classList.add('hidden');
                    document.getElementById('step3').classList.remove('hidden');
                    window.scrollTo(0,0);
                    // 清空購物車
                    cart = [];
                } else {
                    showToast("伺服器回應錯誤", "error");
                    btn.disabled = false;
                    btn.innerHTML = '確認送出申請';
                }
            } catch (err) {
                showToast("網路通訊失敗", "error");
                btn.disabled = false;
                btn.innerHTML = '確認送出申請';
            }
        }
    </script>
</body>

</html>
